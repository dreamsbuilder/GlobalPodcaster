<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Podcaster - Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .btn:hover { background: #45a049; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .logs {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
        .status {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        .results {
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        .mp3-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid #4CAF50;
            border-radius: 3px;
        }
        .mp3-title {
            font-weight: bold;
            color: #2c3e50;
        }
        .mp3-url {
            font-size: 12px;
            color: #666;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéµ Global Podcaster Dashboard</h1>
        <p>Pipeline de Procesamiento con Generaci√≥n de MP3</p>
    </div>
    
    <div class="status">
        <strong>Estado:</strong> <span id="status">Listo para iniciar</span>
    </div>
    
    <button id="sessionBtn" class="btn" onclick="createSession()">üìã Crear Sesi√≥n</button>
    <button id="pipelineBtn" class="btn" onclick="executePipeline()" disabled>üöÄ Ejecutar Pipeline Completo</button>
    
    <div id="results" class="results">
        <h3>üìà Resultados del Pipeline</h3>
        <div id="mp3List"></div>
    </div>
    
    <div id="logs" class="logs">Esperando comandos...</div>

    <script>
        let session = null;
        let executing = false;

        function log(msg, type = 'info') {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logs.innerHTML += `<span class="${className}">[${time}] ${msg}</span>\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
        }

        function showResults(data) {
            const results = document.getElementById('results');
            const mp3List = document.getElementById('mp3List');
            
            results.style.display = 'block';
            
            const content = data.result?.content || data;
            const feeds = content.feeds_checked || 0;
            const episodes = content.new_episodes_found || 0;
            const orchestrator = content.orchestrator_result || {};
            const mp3Results = orchestrator.results || [];
            
            mp3List.innerHTML = `
                <div class="mp3-item">
                    <div class="mp3-title">üìä Resumen del Pipeline</div>
                    <div class="mp3-url">Feeds: ${feeds} | Episodios: ${episodes} | MP3s generados: ${mp3Results.length}</div>
                </div>
            `;
            
            if (mp3Results.length > 0) {
                mp3Results.forEach((result, i) => {
                    if (result.content && Array.isArray(result.content)) {
                        result.content.forEach((item, j) => {
                            if (item.tts_audio_url) {
                                mp3List.innerHTML += `
                                    <div class="mp3-item">
                                        <div class="mp3-title">üéµ MP3 ${i+1}-${j+1}: ${item.title}</div>
                                        <div class="mp3-url">${item.tts_audio_url}</div>
                                    </div>
                                `;
                            }
                        });
                    }
                });
            }
        }

        function createSession() {
            session = {id: 'session-' + Date.now()};
            document.getElementById('sessionBtn').textContent = '‚úÖ Sesi√≥n Activa';
            document.getElementById('sessionBtn').disabled = true;
            document.getElementById('pipelineBtn').disabled = false;
            log('‚úÖ Sesi√≥n creada exitosamente: ' + session.id, 'success');
            updateStatus('Sesi√≥n activa - Listo para ejecutar pipeline');
        }

        async function executePipeline() {
            if (!session) {
                log('‚ùå No hay sesi√≥n activa', 'error');
                return;
            }
            
            executing = true;
            document.getElementById('pipelineBtn').disabled = true;
            document.getElementById('pipelineBtn').textContent = '‚è≥ Ejecutando...';
            
            log('üöÄ Iniciando pipeline completo de Global Podcaster...', 'info');
            log('üìã Comando: CHECK_FEEDS ‚Üí transcripci√≥n ‚Üí traducci√≥n ‚Üí TTS ‚Üí MP3', 'info');
            updateStatus('Ejecutando pipeline...');
            
            try {
                const response = await fetch('/api/execute-real-pipeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'CHECK_FEEDS',
                        method: 'direct'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ Pipeline ejecutado exitosamente!', 'success');
                    
                    // Parsear resultados
                    const content = result.result?.content || result;
                    const feeds = content.feeds_checked || 0;
                    const episodes = content.new_episodes_found || 0;
                    const orchestrator = content.orchestrator_result || {};
                    
                    log(`üìä Feeds verificados: ${feeds}`, 'success');
                    log(`üéµ Episodios nuevos encontrados: ${episodes}`, 'success');
                    log(`üîß Status orchestrator: ${orchestrator.status || 'N/A'}`, 'info');
                    
                    if (orchestrator.results && orchestrator.results.length > 0) {
                        let totalMp3s = 0;
                        orchestrator.results.forEach(result => {
                            if (result.content && Array.isArray(result.content)) {
                                result.content.forEach(item => {
                                    if (item.tts_audio_url) {
                                        totalMp3s++;
                                        log(`üéµ MP3 generado: ${item.title}`, 'success');
                                        log(`   üìÇ URL: ${item.tts_audio_url}`, 'info');
                                    }
                                });
                            }
                        });
                        log(`üéâ ¬°${totalMp3s} MP3s generados exitosamente!`, 'success');
                        showResults(result);
                    } else {
                        log('‚ö†Ô∏è No se generaron MP3s. Verificar configuraci√≥n.', 'error');
                    }
                    
                    updateStatus(`Pipeline completado - ${orchestrator.results?.length || 0} resultados`);
                } else {
                    const errorText = await response.text();
                    log('‚ùå Error en pipeline: ' + response.status, 'error');
                    log('‚ùå Detalles: ' + errorText, 'error');
                    updateStatus('Error en pipeline');
                }
            } catch (error) {
                log('‚ùå Error de conexi√≥n: ' + error.message, 'error');
                log('üí° Aseg√∫rate de que el servidor Vite est√© corriendo', 'info');
                updateStatus('Error de conexi√≥n');
            }
            
            executing = false;
            document.getElementById('pipelineBtn').disabled = false;
            document.getElementById('pipelineBtn').textContent = 'üöÄ Ejecutar Pipeline Completo';
        }

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            log('üîß Global Podcaster Dashboard inicializado', 'success');
            log('üí° Crear sesi√≥n para comenzar el proceso', 'info');
            log('üìã El pipeline incluye: Feed Monitor ‚Üí Transcripci√≥n ‚Üí Traducci√≥n ‚Üí TTS ‚Üí MP3', 'info');
        });
    </script>
</body>
</html>
